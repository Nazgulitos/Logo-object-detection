# Computer Vision: Детекция логотипа Т-Банка

REST API сервис для детекции логотипа Т‑Банка на изображениях с помощью дообученной модели YOLOv8n.

## Содержание
- [Требования](#требования)
- [Установка и запуск локально](#установка-и-запуск-локально)
- [Запуск через Docker](#docker)
- [Контракт API](#контракт-api)
- [Валидация и метрики](#валидация-и-метрики)
- [Датасет](#датасет)
- [Дообучение модели и выбор архитектуры](#дообучение-модели-и-выбор-архитектуры)
- [Построение FastAPI сервиса](#построение-fastapi-сервиса)
- [Производительность](#производительность)
- [Структура проекта](#структура-проекта)
- [Заключение](#заключение)

---

## Требования
- Поддерживаемые форматы изображений: JPEG, PNG, BMP, WEBP
- Порт сервиса: 8000
- Ограничение по времени: ≤ 10 сек/изображение (при наличии GPU ускорителя)
- Локальный запуск: Python 3.12

---

## Установка и запуск локально
1) Создайте и активируйте окружение Python 3.12
```bash
cd Logo-object-detection
python3.12 -m venv .venv
source .venv/bin/activate   # Mac / Linux
.venv\Scripts\Activate.ps1  # Windows (PowerShell)
```
2) Установите зависимости:
```bash
pip install -r requirements.txt
```
3) Убедитесь, что файл весов модели YOLOv8n лежит по пути `models/best-yolov8n.pt`.
4) Запустите API:
```bash
uvicorn code.main:app --host 0.0.0.0 --port 8000
```

Проверка работоспособности:
```bash
curl http://localhost:8000/healthz
```

Интерактивная документация (Swagger UI) будет доступна на `http://localhost:8000/docs`.

---

## Запуск через Docker
Сборка образа и запуск контейнера:
```bash
docker build -t tbank-logo-api .
docker run --rm -p 8000:8000 -v "$PWD/models:/app/models" tbank-logo-api
```

API будет доступен на `http://localhost:8000`.

---

## Контракт API
Pydantic-схемы и эндпоинты находятся в `code/main.py`.

POST `/detect`
- Вход: multipart `file` — изображение в одном из форматов: JPEG/PNG/BMP/WEBP
- Выход: JSON со списком детекций, каждая детекция содержит `bbox` в абсолютных пиксельных координатах

Пример запроса:
```bash
curl -X POST \
  -F "file=@data/dataset/test/images/any.jpg" \
  http://localhost:8000/detect
```

Пример ответа:
```json
{
  "detections": [
    {"bbox": {"x_min": 100, "y_min": 80, "x_max": 220, "y_max": 200}}
  ]
}
```

GET `/healthz`
- Быстрая проверка готовности сервиса.

---

## Валидация и метрики
Скрипт `code/validate.py` считает Precision/Recall/F1 при IoU=0.5 на валидационном наборе в формате YOLO.

Пример запуска:
```bash
python -m code.validate --weights models/best-yolov8n.pt \
  --images data/dataset/valid/images \
  --labels data/dataset/valid/labels \
  --iou 0.5
```

Пример вывода:
```json
{
  "precision": 0.92,
  "recall": 0.88,
  "f1": 0.90
}
```

---

## Датасет
Всего в сырых неразмеченных данных — около 30 тыс. изображений, включающих фото с логотипом Т‑Банка.

Разметка выполнялась на платформе Roboflow:
- ручная разметка 50 фото;
- автоматическая разметка ИИ моделью на оставшихся фото.

Классы: `logo` или `null` (если на изображении ничего нет).

Итого 255 размеченных фото: 125 содержат одно или несколько лого, 130 — не содержат лого.

Разбиение набора:
- train (160: 84 logo, 76 null)
- validate (40: 21 logo, 19 null)
- test (50: 20 logo, 30 null)

Аугментации (Roboflow) для train с генерацией дополнительных примеров:
- Rotation: −45°…+45°
- Shear: ±15° по горизонтали/вертикали
- Hue: −100…+100
- Brightness: −15%…+15%
- Blur: до 1px
- Bounding Box: Flip (H/V)
- Bounding Box: Shear ±10° (H/V)

Итоговый набор: train (~79%), validate (~10%), test (~12%).
Датасет экспортирован в формат YOLO и размещён в `data/dataset/`:
```
data/dataset/
  ├─ train/
  ├─ valid/
  ├─ test/
  └─ data.yaml
```

---

## Дообучение модели и выбор архитектуры

Код обучения запускался на платформе [Kaggle](https://www.kaggle.com/) со следующей конфигурацией:
- Accelerator: GPU T4x2 (фактически использовалась 1 карта с 16 ГБ VRAM).

### Причины выбора YOLOv8n
1. **Высокая производительность.** `YOLOv8n (nano)` — самая маленькая и быстрая модель семейства, что критично для REST API с низкими задержками и для развёртывания в Docker.
2. **Точность и эффективность.** Отличный баланс между скоростью и качеством для задачи детекции одного простого объекта (логотипа).
3. **Простота использования.** Библиотека Ultralytics даёт удобный интерфейс для обучения и инференса, ускоряя прототипирование и интеграцию.

### Сравнение с альтернативами
- **Более крупные и новые модели YOLO.** Точнее на сложных сценах, но медленнее и тяжелее. Для одного класса (лого) избыточны. Выполнен эксперимент с `YOLOv11n` при тех же гиперпараметрах — по итоговым метрикам выбрана `YOLOv8n`.
- **Трансформеры.** Отличная производительность на плотных сценах, но дорогие по ресурсам и сложные в интеграции.
- **Двухэтапные детекторы (Faster R‑CNN).** Выше точность для мелких объектов, но существенно медленнее, что плохо для real‑time API.

### Анализ гиперпараметров
- `epochs=100`: оптимально; пик качества достигался раньше, что видно по графикам.
- `imgsz=640`: стандарт для YOLOv8, хороший баланс точности/скорости.
- `patience=50`: ранняя остановка, предотвращает переобучение.

#### Для воспроизведения экспериментов и подробностей обучения см. ноутбук в каталоге `notebooks/yolov8n-finetuning.ipynb`.
#### Веса дообученых моделей yolov8n и yolo11n см. в каталоге `models/`
---

## Построение FastAPI сервиса
Сервис реализован на базе FastAPI и uvicorn. Основные элементы находятся в `code/`:
- `code/models.py`: обёртка `YoloDetector` над Ultralytics YOLOv8. Возвращает абсолютные bbox в пикселях, фильтрует только класс `0` (logo), конфиденция по умолчанию `0.25`, устройство выбирается автоматически.
- `code/main.py`: FastAPI‑приложение. Загрузка модели (первый запрос), эндпоинты `/detect` и `/healthz`, валидация форматов изображений, обработка ошибок.
- `Dockerfile`: образ, системные зависимости для Pillow/OpenCV, команда запуска uvicorn.

Особенности реализации:
- Поддерживаемые типы контента: `image/jpeg`, `image/png`, `image/bmp`, `image/webp`.
- Файл весов по умолчанию: `models/best-yolov8n.pt`.
- Документация API доступна на `/docs` (Swagger UI) и `/redoc`.

---

## Производительность
По результатам экспериментов:
- Speed: 4.0 ms preprocess, 13.7 ms inference, 0.0 ms loss, 0.6 ms postprocess на изображение
- mAP50‑95: 0.9243393130670438
- mAP50: 0.995
- mAP75: 0.9884782608695654

Примечание: фактическая скорость зависит от железа (CPU/GPU) и размера входного изображения, данные показатели были измерены на MacBook Air M1, 2020, 8 GB.

---

## Структура проекта
```
Logo-object-detection/
  ├─ code/
  │   ├─ __init__.py
  │   ├─ main.py          # FastAPI приложение (эндпоинты /detect, /healthz)
  │   └─ models.py        # Обёртка над YOLOv8 (инференс)
  │   └─ validate.py      # Скрипт для валидации тестовой выборки
  ├─ data/
  │   └─ dataset/         # Набор данных в формате YOLO (train/valid/test, data.yaml)
  ├─ models/
  │   └─ best-yolov8n.pt  # Веса модели по умолчанию
  │   └─ best-yolo11n.pt  # Веса альтернативной модели
  ├─ notebooks/           # Ноутбуки с обучением/экспериментами
  ├─ Dockerfile
  ├─ requirements.txt
  └─ README.md.           # Документация проекта
```

---


## Заключение

### Анализ ограничений
- Детекция очень мелких логотипов может быть затруднена (потери при ресайзе/feature‑экстракции).
- Сильные искажения/окклюзии и редкие ракурсы, отсутствовавшие в обучении, ухудшают качество.
- Узкая специализация (один класс) — ограниченная обобщаемость на иные задачи/логотипы.

### Сильные и слабые стороны
**Сильные стороны:**
- скорость (YOLOv8n), высокая точность (mAP50‑95 > 0.92), компактность и простота интеграции;
- удобные инструменты Ultralytics для обучения и инференса.

**Слабые стороны:**
- чувствительность к распределению данных, для устойчивости необходим разнообразный датасет и аугментации;
- фокус на одном типе объекта.

### Дополнительные улучшения
1. Расширение датасета сложными примерами (мелкие лого, искажения, окклюзии).
2. Использование более мощных моделей при меньших ограничениях на скорость.
3. Исследование двухэтапных детекторов для мелких объектов (с учётом падения скорости).

Общий вывод: выбранная архитектура `YOLOv8n` обеспечивает оптимальный компромисс для REST API‑сервиса детекции логотипа Т‑Банка — высокая точность при минимальных требованиях к ресурсам и быстрой инференс‑скорости, что критично для продакшен‑развёртывания.
